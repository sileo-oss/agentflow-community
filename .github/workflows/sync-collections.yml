name: Sync Collections to API

on:
  push:
    branches: [main]
    paths: 
      - 'collections/**'
      - 'public_collections.yaml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        type: boolean
        default: false
      force_full_sync:
        description: 'Force full sync (ignore LAST_SYNC_COMMIT)'
        type: boolean
        default: false

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate collections
        run: |
          chmod +x ./scripts/validate-collections.sh
          ./scripts/validate-collections.sh

  sync:
    runs-on: ubuntu-latest
    needs: validate  # Only run sync after validation succeeds
    container:
      image: ghcr.io/${{ github.repository_owner }}/agentflow-sync:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout collections repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Fix git safe directory
        run: git config --global --add safe.directory /github/workspace

      - name: Sync collections to API
        run: node /app/scripts/sync-collections.js
        env:
          ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          LAST_SYNC_COMMIT: ${{ github.event.inputs.force_full_sync == 'true' && '' || vars.LAST_SYNC_COMMIT }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}

      - name: Update sync state
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          git config --global --add safe.directory /github/workspace
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "LAST_SYNC_COMMIT=$CURRENT_COMMIT" >> $GITHUB_ENV
          echo "Updating LAST_SYNC_COMMIT to: $CURRENT_COMMIT"
          gh variable set LAST_SYNC_COMMIT --body "$CURRENT_COMMIT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report sync failure
        if: failure()
        run: |
          echo "::error::Collection sync failed. LAST_SYNC_COMMIT was not updated."
          echo "Next run will retry from the same commit: ${{ vars.LAST_SYNC_COMMIT }}"