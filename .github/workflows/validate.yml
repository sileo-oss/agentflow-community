name: Validate Collections

on:
  pull_request:
    paths:
      - 'collections/**'
      - 'public_collections.yaml'
  push:
    branches: [main]
    paths:
      - 'collections/**'
      - 'public_collections.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate collections
        run: ./scripts/validate-collections.sh

      - name: Check collection structure
        run: |
          echo "Checking collection structure..."
          
          # Verify each collection has required structure
          for collection_dir in collections/*/; do
            if [ -d "$collection_dir" ]; then
              collection_name=$(basename "$collection_dir")
              echo "Checking collection: $collection_name"
              
              # Check metadata.json exists and has required fields
              if [ ! -f "$collection_dir/metadata.json" ]; then
                echo "❌ Missing metadata.json in $collection_name"
                exit 1
              fi
              
              # Validate metadata has required fields
              if ! jq -e '.name and .description' "$collection_dir/metadata.json" >/dev/null; then
                echo "❌ metadata.json missing required fields in $collection_name"
                exit 1
              fi
              
              echo "✅ Collection $collection_name is valid"
            fi
          done

      - name: Validate public collections config
        run: |
          echo "Validating public_collections.yaml..."
          
          if [ ! -f "public_collections.yaml" ]; then
            echo "❌ public_collections.yaml not found"
            exit 1
          fi
          
          # Validate YAML syntax
          yq . public_collections.yaml >/dev/null
          
          # Check that all referenced collections exist
          if yq -e '.collection_ids' public_collections.yaml >/dev/null; then
            yq -r '.collection_ids[]' public_collections.yaml | while read -r collection_id; do
              if [ ! -d "collections/$collection_id" ]; then
                echo "❌ Public collection $collection_id not found in collections/"
                exit 1
              fi
              echo "✅ Public collection $collection_id exists"
            done
          fi
          
          echo "✅ public_collections.yaml is valid"