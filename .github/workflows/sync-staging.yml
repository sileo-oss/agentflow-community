name: Sync Collections to Staging

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths: 
      - 'collections/**'
      - 'public_collections.yaml'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to sync'
        required: true
        type: number
      force_full_sync:
        description: 'Force full sync (ignore LAST_SYNC_COMMIT)'
        type: boolean
        default: false

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate collections
        run: ./scripts/validate-collections.sh

  sync-to-staging:
    runs-on: ubuntu-latest
    needs: validate
    container:
      image: ghcr.io/${{ github.repository_owner }}/agentflow-sync:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Fix git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Set staging sync commit variable
        run: |
          if [ "${{ github.event.inputs.force_full_sync }}" = "true" ]; then
            echo "LAST_SYNC_COMMIT=" >> $GITHUB_ENV
            echo "Force full sync enabled - LAST_SYNC_COMMIT set to empty"
          else
            echo "LAST_SYNC_COMMIT=${{ vars.STAGING_LAST_SYNC_COMMIT }}" >> $GITHUB_ENV
            echo "Incremental sync - LAST_SYNC_COMMIT set to: ${{ vars.STAGING_LAST_SYNC_COMMIT }}"
          fi

      - name: Sync collections to Staging API
        run: | 
          echo "current LAST_SYNC_COMMIT is: $LAST_SYNC_COMMIT"
          echo "starting the sync-collections script for STAGING"
          node /app/scripts/sync-collections.js
        env:
          ADMIN_API_TOKEN: ${{ secrets.STAGING_ADMIN_API_TOKEN }}
          API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          LAST_SYNC_COMMIT: ${{ env.LAST_SYNC_COMMIT }}
          DRY_RUN: false
          COLLECTIONS_DIR: ${{ github.workspace }}/collections

      - name: Update staging sync state
        if: success()
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "Updating STAGING_LAST_SYNC_COMMIT to: $CURRENT_COMMIT"
          gh variable set STAGING_LAST_SYNC_COMMIT --body "$CURRENT_COMMIT"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || ${{ github.event.inputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Collections successfully synced to **staging** environment!\n\nYou can now test these changes in staging before merging to production.'
            })

      - name: Report sync failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || ${{ github.event.inputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Failed to sync collections to staging environment.\n\nPlease check the workflow logs for details.'
            })
